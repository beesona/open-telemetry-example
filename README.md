# Open Telemetry Example

- Uses an Express Instrumentation.
- Implements custom trace spans with experimental decorators.

## To run this with Open-Telemetry bootstrapped

- use the command `npx ts-node --require ./src/instrumentation.ts ./src/index.ts`

## Exploring Trace Telemetry

When a request comes into the Express server, instrumentation, Express and Custom, begin tracing the request. The following is an example of POST request telemetry. Note some of the following data:

- The first record is the Express Server.
- The second record is the HTTP Route abstraction layer.
  - This is custom telemetry that includes the method arguments.
- The final record is the business logic.
- Every call in the request shares a traceId.
- Every subsequent call has a parentId that matches the id of the call before it.

```
{
  traceId: '17420fa70c4c5e019eecd70bf9acf2d6',
  parentId: undefined,
  traceState: undefined,
  name: 'POST /business',
  id: 'df4732631beaabe1',
  kind: 1,
  timestamp: 1712875736247000,
  duration: 30040.791,
  attributes: {
    'http.url': 'http://localhost:8080/business',
    'http.host': 'localhost:8080',
    'net.host.name': 'localhost',
    'http.method': 'POST',
    'http.scheme': 'http',
    'http.target': '/business',
    'http.user_agent': 'PostmanRuntime/7.37.0',
    'http.request_content_length_uncompressed': 41,
    'http.flavor': '1.1',
    'net.transport': 'ip_tcp',
    'net.host.ip': '::1',
    'net.host.port': 8080,
    'net.peer.ip': '::1',
    'net.peer.port': 52072,
    'http.status_code': 201,
    'http.status_text': 'CREATED',
    'http.route': '/business'
  },
  status: { code: 0 },
  events: [],
  links: []
},
{
  traceId: '17420fa70c4c5e019eecd70bf9acf2d6',
  parentId: 'df4732631beaabe1',
  traceState: undefined,
  name: 'postRequest',
  id: 'efde36046dbad3af',
  kind: 0,
  timestamp: 1712875736274000,
  duration: 102.5,
  attributes: {
    methodArgs: '[{"context":{"requestType":"POST","requestBody":{"id":"hello","value":"world"}}}]'
  },
  status: { code: 0 },
  events: [],
  links: []
},
{
  traceId: '17420fa70c4c5e019eecd70bf9acf2d6',
  parentId: 'efde36046dbad3af',
  traceState: undefined,
  name: 'createRecord',
  id: '6dce7bdf049e2409',
  kind: 0,
  timestamp: 1712875736274000,
  duration: 19.958,
  attributes: { methodArgs: '[{"id":"hello","value":"world"}]' },
  status: { code: 0 },
  events: [],
  links: []
}
```

Then compare this trace to the next call, which is a GET request:

- The traceId has changed.
- All of this telemetry is generated by the same traceMethod decorators, making it generic and extensible.

```
{
  traceId: 'afacd622d2c18c4a6388243ded28a0b8',
  parentId: undefined,
  traceState: undefined,
  name: 'GET /business/:id',
  id: 'e6c9a31f5854c774',
  kind: 1,
  timestamp: 1712876384595000,
  duration: 6356.625,
  attributes: {
    'http.url': 'http://localhost:8080/business/hello',
    'http.host': 'localhost:8080',
    'net.host.name': 'localhost',
    'http.method': 'GET',
    'http.scheme': 'http',
    'http.target': '/business/hello',
    'http.user_agent': 'PostmanRuntime/7.37.0',
    'http.flavor': '1.1',
    'net.transport': 'ip_tcp',
    'net.host.ip': '::1',
    'net.host.port': 8080,
    'net.peer.ip': '::1',
    'net.peer.port': 54823,
    'http.status_code': 200,
    'http.status_text': 'OK',
    'http.route': '/business/:id'
  },
  status: { code: 0 },
  events: [],
  links: []
},
{
  traceId: 'afacd622d2c18c4a6388243ded28a0b8',
  parentId: 'e6c9a31f5854c774',
  traceState: undefined,
  name: 'getRequest',
  id: '6064849f073a1503',
  kind: 0,
  timestamp: 1712876384599000,
  duration: 185.041,
  attributes: { methodArgs: '["hello"]' },
  status: { code: 0 },
  events: [],
  links: []
},
{
  traceId: 'afacd622d2c18c4a6388243ded28a0b8',
  parentId: '6064849f073a1503',
  traceState: undefined,
  name: 'getRecord',
  id: '67e4fa01610ea203',
  kind: 0,
  timestamp: 1712876384600000,
  duration: 71.125,
  attributes: { methodArgs: '["hello"]' },
  status: { code: 0 },
  events: [],
  links: []
}
```
